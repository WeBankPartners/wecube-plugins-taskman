<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webank.taskman.mapper.FormItemTemplateMapper">

    <update id="deleteRequestTemplateByIDMapper">
       UPDATE form_item_template SET del_flag=1 WHERE id = #{id}
    </update>

    <delete id="deleteByDomain" parameterType="com.webank.taskman.domain.FormItemTemplate">
        DELETE FROM form_item_template
        <where>
            <if test="formTemplateId != null and formTemplateId != ''">
               AND  form_template_id=#{formTemplateId}
            </if>
        </where>
    </delete>

    <select id="getCreateTaskServiceMeta" resultType="com.webank.taskman.dto.resp.TaskServiceMetaFormItem">
        SELECT
            fit.id AS itemId,
            fit.`name` AS `key`,
            (CASE WHEN fit.element_type ='PluginSelect' THEN "ref" ELSE fit.element_type END ) AS "valueDef.type",
            (CASE WHEN fit.element_type ='PluginSelect' THEN CONCAT(fit.package_name,":",fit.entity) ELSE "" END ) AS "valueDef.expr"
        FROM form_item_template fit
        WHERE fit.temp_id in (
            SELECT tt.id FROM task_template tt INNER JOIN request_info ri ON ri.request_temp_id = tt.request_template_id
            AND ri.proc_inst_key= #{procInstKey}
            WHERE tt.node_def_id = #{nodeDefId}
        )
    </select>

</mapper>
